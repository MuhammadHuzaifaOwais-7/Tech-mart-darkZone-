<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout | Secure Payment - DarkZone Store</title>
<meta name="description" content="Complete your purchase securely at the DarkZone Store checkout. Fast and reliable shipping is available across Pakistan.">
<meta name="keywords" content="checkout, secure payment, order confirmation, shipping, buy online, cart total">    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

    <style>
        /* ======================================= */
        /* 1. DARKZONE BASE STYLES & LAYOUT        */
        /* ======================================= */
        body {
            font-family: "Poppins", sans-serif;
            background: #0a0a0f;
            color: #e0f7fa;
            min-height: 100vh;
            padding-top: 80px;
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 20px; 
            animation: fadeIn 1s ease; 
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        h1 { 
            color: #00f5ff; 
            text-align: center; 
            margin-bottom: 30px; 
            text-shadow: 0 0 10px #00f5ff; 
        }
        
        .checkout-grid { 
            display: grid; 
            grid-template-columns: 2fr 1fr; /* 66% for form, 33% for summary */
            gap: 40px; 
        }
        
        .card { 
            background: #12121a; 
            padding: 25px; 
            border-radius: 10px; 
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2); 
            height: fit-content; /* Important for alignment */
        }
        
        /* Form & Input Styles */
        #checkoutForm {
            display: flex;
            flex-direction: column;
            /* Ensures form elements take full width inside the card */
            width: 100%; 
            align-items: center; /* Center the button */
        }

        input, select { 
            width: 100%; /* Take up the full width of the form space */
            padding: 12px;
            margin: 8px 0 20px 0; /* Reduced top margin, kept bottom margin */
            border: 1px solid #00f5ff44;
            border-radius: 5px;
            background: #1a1a24;
            color: #fff;
            outline: none;
            transition: 0.3s;
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }
        input:focus, select:focus { border-color: #00f5ff; box-shadow: 0 0 5px #00f5ff; }
        .form-group { margin-bottom: 10px; width: 100%; } /* Adjusted margin and set width */
        label { display: block; margin-bottom: 5px; color: #ccc; font-size: 0.9em; }

        /* Order Summary Styles */
        .cart-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #00ffff22; }
        .cart-item:last-child { border-bottom: none; }
        .total-box { text-align: right; padding-top: 20px; font-size: 1.2em; font-weight: bold; color: #00f5ff; }
        
        /* Navbar (for context) */
        .navbar { display: flex; justify-content: space-between; align-items: center; background: rgba(15, 12, 41, 0.9); padding: 15px 30px; position: fixed; top: 0; left: 0; width: 100%; z-index: 999; backdrop-filter: blur(5px); }
        .navbar .logo { font-size: 1.5em; font-weight: bold; color: #00f5ff; }
        .navbar ul { display: flex; gap: 20px; list-style: none; margin: 0; padding: 0; }
        .navbar a { color: white; text-decoration: none; transition: 0.3s; }
        
        /* === NEW STYLING FOR HAMBURGER MENU (.menu-toggle) === */
        .menu-toggle {
            /* Default: Hidden on Desktop (Full menu is visible) */
            display: none;
            
            /* Neon Styling (Matching index.html) */
            background: transparent; 
            color: #00e5ff; 
            font-size: 1.5em;
            line-height: 1; /* Helps vertical alignment of the icon */
            border: 1px solid #00e5ff;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }
        .menu-toggle:hover {
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.8);
        }
        .menu-toggle:focus {
            box-shadow: 0 0 0 0.25rem rgba(0, 229, 255, 0.5);
            outline: none;
        }
        /* ======================================================= */

        /* ======================================= */
        /* 2. TRUCK BUTTON STYLES (Adjusted)       */
        /* ======================================= */
        /* These styles define the complex 3D animation */
        html { box-sizing: border-box; -webkit-font-smoothing: antialiased; } 
        * { box-sizing: inherit; &:before, &:after { box-sizing: inherit; } }

        .truck-button { 
            /* ... (keep existing CSS variables for animation) ... */
            --color: #fff; 
            --background: #2B3044; 
            --tick: #16BF78; 
            --base: #0D0F18; 
            --wheel: #2B3044; 
            --wheel-inner: #646B8C; 
            --wheel-dot: #fff; 
            --back: #6D58FF; 
            --back-inner: #362A89; 
            --back-inner-shadow: #2D246B; 
            --front: #A6ACCD; 
            --front-shadow: #535A79; 
            --front-light: #FFF8B1; 
            --window: #2B3044; 
            --window-shadow: #404660; 
            --street: #646B8C; 
            --street-fill: #404660; 
            --box: #DCB97A; 
            --box-shadow: #B89B66; 
            
            padding: 12px 0; 
            width: 172px; 
            cursor: pointer; 
            text-align: center; 
            position: relative; 
            border: none; 
            outline: none; 
            color: var(--color); 
            background: var(--background); 
            border-radius: var(--br, 15px); 
            -webkit-appearance: none; 
            -webkit-tap-highlight-color: transparent; 
            transform-style: preserve-3d; 
            transform: rotateX(var(--rx, 0deg)) translateZ(0); 
            transition: transform .5s, border-radius .3s linear var(--br-d, 0s); 
            margin-top: 30px; /* **Increased spacing from select box** */
            margin-bottom: 5px; 
        }
        
        /* The rest of the truck-button CSS remains unchanged for functionality */
        .truck-button:before, .truck-button:after { content: ''; position: absolute; left: 0; top: 0; width: 100%; height: 6px; display: block; background: var(--b, var(--street)); transform-origin: 0 100%; transform: rotateX(90deg) scaleX(var(--sy, 1)); } 
        .truck-button:after { --sy: var(--progress, 0); --b: var(--street-fill); } 
        .truck-button .default, .truck-button .success { display: block; font-weight: 500; font-size: 14px; line-height: 24px; opacity: var(--o, 1); transition: opacity .3s; } 
        .truck-button .success { --o: 0; position: absolute; top: 12px; left: 0; right: 0; }
        .truck-button .success svg { width: 12px; height: 10px; display: inline-block; vertical-align: top; fill: none; margin: 7px 0 0 12px; stroke: var(--tick); stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; stroke-dasharray: 16px; stroke-dashoffset: var(--offset, 16px); transition: stroke-dashoffset .4s ease .45s; } 
        .truck-button .truck { position: absolute; width: 72px; height: 28px; transform: rotateX(90deg) translate3d(var(--truck-x, 4px), calc(var(--truck-y-n, -26) * 1px), 12px); } 
        .truck-button .truck:before, .truck-button .truck:after { content: ''; position: absolute; bottom: -6px; left: var(--l, 18px); width: 10px; height: 10px; border-radius: 50%; z-index: 2; box-shadow: inset 0 0 0 2px var(--wheel), inset 0 0 0 4px var(--wheel-inner); background: var(--wheel-dot); transform: translateY(calc(var(--truck-y) * -1px)) translateZ(0); } 
        .truck-button .truck:after { --l: 54px; } 
        .truck-button .truck .wheel, .truck-button .truck .wheel:before { position: absolute; bottom: var(--b, -6px); left: var(--l, 6px); width: 10px; height: 10px; border-radius: 50%; background: var(--wheel); transform: translateZ(0); } 
        .truck-button .truck .wheel { transform: translateY(calc(var(--truck-y) * -1px)) translateZ(0); } 
        .truck-button .truck .wheel:before { --l: 35px; --b: 0; content: ''; } 
        .truck-button .truck .front, .truck-button .truck .back, .truck-button .truck .box { position: absolute; } 
        .truck-button .truck .back { left: 0; bottom: 0; z-index: 1; width: 47px; height: 28px; border-radius: 1px 1px 0 0; background: linear-gradient(68deg, var(--back-inner) 0%, var(--back-inner) 22%, var(--back-inner-shadow) 22.1%, var(--back-inner-shadow) 100%); } 
        .truck-button .truck .back:before, .truck-button .truck .back:after { content: ''; position: absolute; } 
        .truck-button .truck .back:before { left: 11px; top: 0; right: 0; bottom: 0; z-index: 2; border-radius: 0 1px 0 0; background: var(--back); } 
        .truck-button .truck .back:after { border-radius: 1px; width: 73px; height: 2px; left: -1px; bottom: -2px; background: var(--base); } 
        .truck-button .truck .front { left: 47px; bottom: -1px; height: 22px; width: 24px; -webkit-clip-path: polygon(55% 0, 72% 44%, 100% 58%, 100% 100%, 0 100%, 0 0); clip-path: polygon(55% 0, 72% 44%, 100% 58%, 100% 100%, 0 100%, 0 0); background: linear-gradient(84deg, var(--front-shadow) 0%, var(--front-shadow) 10%, var(--front) 12%, var(--front) 100%); } 
        .truck-button .truck .front:before, .truck-button .truck .front:after { content: ''; position: absolute; } 
        .truck-button .truck .front:before { width: 7px; height: 8px; background: #fff; left: 7px; top: 2px; -webkit-clip-path: polygon(0 0, 60% 0%, 100% 100%, 0% 100%); clip-path: polygon(0 0, 60% 0%, 100% 100%, 0% 100%); background: linear-gradient(59deg, var(--window) 0%, var(--window) 57%, var(--window-shadow) 55%, var(--window-shadow) 100%) } 
        .truck-button .truck .front:after { width: 3px; height: 2px; right: 0; bottom: 3px; background: var(--front-light); } 
        .truck-button .truck .box { width: 13px; height: 13px; right: 56px; bottom: 0; z-index: 1; border-radius: 1px; overflow: hidden; transform: translate(calc(var(--box-x, -24) * 1px), calc(var(--box-y, -6) * 1px)) scale(var(--box-s, .5)); opacity: var(--box-o, 0); background: linear-gradient(68deg, var(--box) 0%, var(--box) 50%, var(--box-shadow) 50.2%, var(--box-shadow) 100%); background-size: 250% 100%; background-position-x: calc(var(--bx, 0) * 1%); } 
        .truck-button .truck .box:before, .truck-button .truck .box:after { content: ''; position: absolute; } 
        .truck-button .truck .box:before { content: ''; background: rgba(255, 255, 255, .2); left: 0; right: 0; top: 6px; height: 1px; } 
        .truck-button .truck .box:after { width: 6px; left: 100%; top: 0; bottom: 0; background: var(--back); transform: translateX(calc(var(--hx, 0) * 1px)); }
        
        .truck-button.animation { --rx: -90deg; --br: 0; } 
        .truck-button.animation .default { --o: 0; } 
        .truck-button.animation.done { --rx: 0deg; --br: 15px; --br-d: .2s; } 
        .truck-button.animation.done .success { --o: 1; --offset: 0; }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) { 
            .checkout-grid { grid-template-columns: 1fr; }
            .navbar ul {
                position: absolute; top: 65px; left: 0; width: 100%; background: #0a0a0f; 
                flex-direction: column; align-items: center; gap: 15px; padding: 20px 0;
                max-height: 0; overflow: hidden; opacity: 0;
                transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            }
            .navbar ul.active { max-height: 300px; opacity: 1; }
            .menu-toggle { display: block; } /* Show the stylish toggler on mobile */
        }
        @media (max-width: 480px) {
            .container { padding: 10px; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">DarkZone Store</div>
        <button class="menu-toggle" onclick="toggleMenu()">&#9776;</button>
        <ul id="menuList">
            <li><a href="../index.html">Home</a></li>
            <li><a href="signup.html">Sign Up</a></li>
            <li><a href="login.html">Log in</a></li>
        </ul>
    </nav>

    <div class="container">
        <h1>Secure Checkout</h1>
        
        <div class="checkout-grid">
            <div class="card">
                <h2>Shipping Information</h2>
                <form id="checkoutForm">
                    <div class="form-group">
                        <label for="name">Full Name (Auto-filled from session)</label>
                        <input type="text" id="name" required placeholder="Ahsan Ali">
                    </div>
                    <div class="form-group">
                        <label for="address">Shipping Address</label>
                        <input type="text" id="address" required placeholder="House 123, Street 4, City">
                    </div>
                    <div class="form-group">
                        <label for="city">City</label>
                        <input type="text" id="city" required placeholder="Karachi">
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone Number</label>
                        <input type="tel" id="phone" required placeholder="03XXXXXXXXX">
                    </div>

                    <h2 style="margin-top: 30px;">Payment</h2>
                    <div class="form-group">
                        <label for="payment">Payment Method</label>
                        <select id="payment" required>
                            <option value="">-- Select Payment --</option>
                            <option value="COD">Cash on Delivery (COD)</option>
                            <option value="card">Credit/Debit Card (Simulated)</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="truck-button" id="animatedPlaceOrderBtn"> 
                        <span class="default">Complete Order</span> 
                        <span class="success"> Order Placed 
                            <svg viewbox="0 0 12 10"> 
                                <polyline points="1.5 6 4.5 9 10.5 1"></polyline> 
                            </svg> 
                        </span> 
                        <div class="truck"> 
                            <div class="wheel"></div> 
                            <div class="back"></div> 
                            <div class="front"></div> 
                            <div class="box"></div> 
                        </div> 
                    </button>
                </form>
            </div>
            
            <div class="card">
                <h2>Order Summary</h2>
                <div id="order-items">
                    <p style="text-align: center; color: #aaa;">Your cart is empty.</p>
                </div>
                
                <div class="total-box">
                    Subtotal: PKR <span id="subtotal">0</span><br>
                    Shipping: PKR <span id="shipping">300</span><br>
                    Total: PKR <span id="final-total">0</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Navbar toggle
        function toggleMenu() {
            document.getElementById("menuList").classList.toggle("active");
        }

        // AUTHENTICATION FUNCTION: Checks for an active session.
        function checkAuthentication() {
            const session = sessionStorage.getItem("currentSession");
            const localUser = localStorage.getItem("techmartUser");

            if (!session) {
                alert("🔒 You must be logged in to complete your order. Redirecting to login page.");
                window.location.href = "login.html";
                return false;
            }

            const currentSession = JSON.parse(session);
            const storedUser = JSON.parse(localUser);

            if (!storedUser || currentSession.username !== storedUser.username) {
                 alert("⚠️ Session mismatch. Please log in again.");
                 sessionStorage.removeItem("currentSession");
                 window.location.href = "login.html";
                 return false;
            }
            
            document.getElementById("name").value = currentSession.username;
            return true;
        }

        let cart = JSON.parse(localStorage.getItem("cart")) || [];
        const shippingCost = 300; 

        function displayOrderSummary() {
            const orderItemsDiv = document.getElementById("order-items");
            const subtotalSpan = document.getElementById("subtotal");
            const finalTotalSpan = document.getElementById("final-total");
            const orderButton = document.getElementById("animatedPlaceOrderBtn");
            
            orderItemsDiv.innerHTML = "";
            let subtotal = 0;

            if (cart.length === 0) {
                orderItemsDiv.innerHTML = '<p style="text-align: center; color: #f00; font-weight: bold;">Your cart is empty. Please add items before checking out.</p>';
                orderButton.disabled = true; 
                return;
            }

            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                
                const div = document.createElement("div");
                div.classList.add("cart-item");
                div.innerHTML = `
                    <span>${item.name} (${item.quantity}x)</span>
                    <span>PKR ${itemTotal.toLocaleString()}</span>
                `;
                orderItemsDiv.appendChild(div);
            });

            const finalTotal = subtotal + shippingCost;
            
            subtotalSpan.textContent = subtotal.toLocaleString();
            document.getElementById("shipping").textContent = shippingCost.toLocaleString();
            finalTotalSpan.textContent = finalTotal.toLocaleString();
            orderButton.disabled = false; 
        }

        // GSAP Animation Logic (for the truck button)
        function triggerTruckAnimation(button, callback) {
            let box = button.querySelector('.box');
            let truck = button.querySelector('.truck');

            // Reset properties 
            gsap.set(truck, { x: 4 }); 
            gsap.set(button, { '--progress': 0, '--hx': 0, '--bx': 0, '--box-s': .5, '--box-o': 0, '--truck-y': 0, '--truck-y-n': -26 }); 
            gsap.set(box, { x: -24, y: -6 });
            button.classList.remove('done'); 

            button.classList.add('animation');
            gsap.to(button, { '--box-s': 1, '--box-o': 1, duration: .3, delay: .5 });
            gsap.to(box, { x: 0, duration: .4, delay: .7 });
            gsap.to(button, { '--hx': -5, '--bx': 50, duration: .18, delay: .92 });
            gsap.to(box, { y: 0, duration: .1, delay: 1.15 });
            
            gsap.set(button, { '--truck-y': 0, '--truck-y-n': -26 });
            gsap.to(button, { 
                '--truck-y': 1, 
                '--truck-y-n': -25, 
                duration: .2, 
                delay: 1.25, 
                onComplete() { 
                    gsap.timeline({ 
                        onComplete() { 
                            button.classList.add('done');
                            // After animation completes, run the submission callback
                            if (callback) callback(); 
                        } 
                    })
                    .to(truck, { x: 0, duration: .4 })
                    .to(truck, { x: 40, duration: 1 })
                    .to(truck, { x: 20, duration: .6 })
                    .to(truck, { x: 96, duration: .4 }); 
                    
                    gsap.to(button, { '--progress': 1, duration: 2.4, ease: "power2.in" }); 
                } 
            });
        }

        // Handle order submission
        document.getElementById("checkoutForm").addEventListener("submit", function(event) {
            event.preventDefault(); 
            
            const orderButton = document.getElementById("animatedPlaceOrderBtn");

            if (!checkAuthentication()) { 
                return;
            }
            
            if (cart.length === 0) {
                alert("Your cart is empty. Please add items to place an order.");
                return;
            }
            
            // Disable button during the process
            orderButton.disabled = true;

            // START ANIMATION
            triggerTruckAnimation(orderButton, () => {
                // --- Submission logic runs AFTER the truck animation is complete ---
                
                const orderDetails = {
                    customer: document.getElementById("name").value,
                    address: document.getElementById("address").value + ', ' + document.getElementById("city").value,
                    phone: document.getElementById("phone").value,
                    payment: document.getElementById("payment").value,
                    items: cart,
                    total: document.getElementById("final-total").textContent,
                    time: new Date().toLocaleString()
                };

                // Clear cart after successful order
                localStorage.removeItem("cart");
                cart = []; 
                
                // Final Redirection
                setTimeout(() => {
                    window.location.href = "../index.html"; 
                }, 1000); // Redirect after 1 second to let the user see the "Order Placed" message
            });
        });

        // Run on page load: AUTHENTICATE FIRST
        if (checkAuthentication()) {
            displayOrderSummary();
        }
    </script>
</body>
</html>